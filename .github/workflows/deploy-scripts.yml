name: Deploy Scripts to EC2

on:
  push:
    branches:
      - main
      - staging
    paths:
      - 'scripts/**'
  workflow_dispatch:  # Permite executar manualmente

jobs:
  deploy-scripts:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set environment variables
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_OUTPUT
            echo "EC2_HOST=${{ secrets.EC2_PROD_HOST }}" >> $GITHUB_OUTPUT
            echo "EC2_USER=${{ secrets.EC2_PROD_USER }}" >> $GITHUB_OUTPUT
            echo "SSH_KEY<<EOF" >> $GITHUB_OUTPUT
            echo "${{ secrets.EC2_PROD_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_OUTPUT
            echo "EC2_HOST=${{ secrets.EC2_STAGING_HOST }}" >> $GITHUB_OUTPUT
            echo "EC2_USER=${{ secrets.EC2_STAGING_USER }}" >> $GITHUB_OUTPUT
            echo "SSH_KEY<<EOF" >> $GITHUB_OUTPUT
            echo "${{ secrets.EC2_STAGING_SSH_KEY }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Deploy scripts to EC2
        env:
          EC2_HOST: ${{ steps.env.outputs.EC2_HOST }}
          EC2_USER: ${{ steps.env.outputs.EC2_USER }}
          SSH_KEY: ${{ steps.env.outputs.SSH_KEY }}
          ENVIRONMENT: ${{ steps.env.outputs.ENVIRONMENT }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          echo "ðŸ“¦ Deploying scripts to $ENVIRONMENT environment..."
          
          # Copia os scripts para o servidor
          scp -o StrictHostKeyChecking=no -i private_key.pem -r scripts/ $EC2_USER@$EC2_HOST:/home/ubuntu/viasegura/
          
          # Configura permissÃµes e reinicia data-loader
          ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
          
            echo "ðŸ“ Navegando para diretÃ³rio da aplicaÃ§Ã£o..."
            cd /home/ubuntu/viasegura || { echo "âŒ DiretÃ³rio nÃ£o encontrado"; exit 1; }
          
            echo "ðŸ”§ Configurando permissÃµes dos scripts..."
            chmod +x scripts/entrypoint.sh
            chmod -R 755 scripts/
          
            echo "ðŸ“‹ Listando arquivos atualizados..."
            ls -la scripts/
          
            echo "ðŸ”„ Reiniciando data-loader..."
            docker-compose stop data-loader || true
            docker-compose rm -f data-loader || true
            docker-compose up -d data-loader
          
            echo "â³ Aguardando data-loader processar..."
            sleep 10
          
            echo "ðŸ“ Logs do data-loader:"
            docker logs --tail 50 data-loader
          
            echo "âœ… Scripts atualizados com sucesso!"
          ENDSSH
          
          rm -f private_key.pem
          
          echo "ðŸŽ‰ Deploy de scripts para $ENVIRONMENT finalizado!"

      - name: Verify deployment
        env:
          EC2_HOST: ${{ steps.env.outputs.EC2_HOST }}
          EC2_USER: ${{ steps.env.outputs.EC2_USER }}
          SSH_KEY: ${{ steps.env.outputs.SSH_KEY }}
        run: |
          echo "$SSH_KEY" > private_key.pem
          chmod 600 private_key.pem
          
          ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'ENDSSH'
            cd /home/ubuntu/viasegura
          
            echo "ðŸ“Š Status do data-loader:"
            docker ps -a --filter name=data-loader --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"
          
            echo ""
            echo "ðŸ“‚ Arquivos em scripts/:"
            ls -lh scripts/
          ENDSSH
          
          rm -f private_key.pem

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Scripts implantados com sucesso!"
          echo "ðŸ”§ Ambiente: ${{ steps.env.outputs.ENVIRONMENT }}"
          echo "ðŸ“¦ Arquivos atualizados em: /home/ubuntu/viasegura/scripts/"

      - name: Notify failure
        if: failure()
        run: |
          echo "âŒ Falha ao implantar scripts!"
          echo "ðŸ“§ Verifique os logs acima"